<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />

<meta name="viewport" content="width=device-width, initial-scale=1">

<meta name="author" content="Steven M. Mortimer" />

<meta name="date" content="2018-03-29" />

<title>Checking Availability with rdfp</title>



<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
</style>



<link href="data:text/css;charset=utf-8,body%20%7B%0Abackground%2Dcolor%3A%20%23fff%3B%0Amargin%3A%201em%20auto%3B%0Amax%2Dwidth%3A%20700px%3B%0Aoverflow%3A%20visible%3B%0Apadding%2Dleft%3A%202em%3B%0Apadding%2Dright%3A%202em%3B%0Afont%2Dfamily%3A%20%22Open%20Sans%22%2C%20%22Helvetica%20Neue%22%2C%20Helvetica%2C%20Arial%2C%20sans%2Dserif%3B%0Afont%2Dsize%3A%2014px%3B%0Aline%2Dheight%3A%201%2E35%3B%0A%7D%0A%23header%20%7B%0Atext%2Dalign%3A%20center%3B%0A%7D%0A%23TOC%20%7B%0Aclear%3A%20both%3B%0Amargin%3A%200%200%2010px%2010px%3B%0Apadding%3A%204px%3B%0Awidth%3A%20400px%3B%0Aborder%3A%201px%20solid%20%23CCCCCC%3B%0Aborder%2Dradius%3A%205px%3B%0Abackground%2Dcolor%3A%20%23f6f6f6%3B%0Afont%2Dsize%3A%2013px%3B%0Aline%2Dheight%3A%201%2E3%3B%0A%7D%0A%23TOC%20%2Etoctitle%20%7B%0Afont%2Dweight%3A%20bold%3B%0Afont%2Dsize%3A%2015px%3B%0Amargin%2Dleft%3A%205px%3B%0A%7D%0A%23TOC%20ul%20%7B%0Apadding%2Dleft%3A%2040px%3B%0Amargin%2Dleft%3A%20%2D1%2E5em%3B%0Amargin%2Dtop%3A%205px%3B%0Amargin%2Dbottom%3A%205px%3B%0A%7D%0A%23TOC%20ul%20ul%20%7B%0Amargin%2Dleft%3A%20%2D2em%3B%0A%7D%0A%23TOC%20li%20%7B%0Aline%2Dheight%3A%2016px%3B%0A%7D%0Atable%20%7B%0Amargin%3A%201em%20auto%3B%0Aborder%2Dwidth%3A%201px%3B%0Aborder%2Dcolor%3A%20%23DDDDDD%3B%0Aborder%2Dstyle%3A%20outset%3B%0Aborder%2Dcollapse%3A%20collapse%3B%0A%7D%0Atable%20th%20%7B%0Aborder%2Dwidth%3A%202px%3B%0Apadding%3A%205px%3B%0Aborder%2Dstyle%3A%20inset%3B%0A%7D%0Atable%20td%20%7B%0Aborder%2Dwidth%3A%201px%3B%0Aborder%2Dstyle%3A%20inset%3B%0Aline%2Dheight%3A%2018px%3B%0Apadding%3A%205px%205px%3B%0A%7D%0Atable%2C%20table%20th%2C%20table%20td%20%7B%0Aborder%2Dleft%2Dstyle%3A%20none%3B%0Aborder%2Dright%2Dstyle%3A%20none%3B%0A%7D%0Atable%20thead%2C%20table%20tr%2Eeven%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0A%7D%0Ap%20%7B%0Amargin%3A%200%2E5em%200%3B%0A%7D%0Ablockquote%20%7B%0Abackground%2Dcolor%3A%20%23f6f6f6%3B%0Apadding%3A%200%2E25em%200%2E75em%3B%0A%7D%0Ahr%20%7B%0Aborder%2Dstyle%3A%20solid%3B%0Aborder%3A%20none%3B%0Aborder%2Dtop%3A%201px%20solid%20%23777%3B%0Amargin%3A%2028px%200%3B%0A%7D%0Adl%20%7B%0Amargin%2Dleft%3A%200%3B%0A%7D%0Adl%20dd%20%7B%0Amargin%2Dbottom%3A%2013px%3B%0Amargin%2Dleft%3A%2013px%3B%0A%7D%0Adl%20dt%20%7B%0Afont%2Dweight%3A%20bold%3B%0A%7D%0Aul%20%7B%0Amargin%2Dtop%3A%200%3B%0A%7D%0Aul%20li%20%7B%0Alist%2Dstyle%3A%20circle%20outside%3B%0A%7D%0Aul%20ul%20%7B%0Amargin%2Dbottom%3A%200%3B%0A%7D%0Apre%2C%20code%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0Aborder%2Dradius%3A%203px%3B%0Acolor%3A%20%23333%3B%0Awhite%2Dspace%3A%20pre%2Dwrap%3B%20%0A%7D%0Apre%20%7B%0Aborder%2Dradius%3A%203px%3B%0Amargin%3A%205px%200px%2010px%200px%3B%0Apadding%3A%2010px%3B%0A%7D%0Apre%3Anot%28%5Bclass%5D%29%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0A%7D%0Acode%20%7B%0Afont%2Dfamily%3A%20Consolas%2C%20Monaco%2C%20%27Courier%20New%27%2C%20monospace%3B%0Afont%2Dsize%3A%2085%25%3B%0A%7D%0Ap%20%3E%20code%2C%20li%20%3E%20code%20%7B%0Apadding%3A%202px%200px%3B%0A%7D%0Adiv%2Efigure%20%7B%0Atext%2Dalign%3A%20center%3B%0A%7D%0Aimg%20%7B%0Abackground%2Dcolor%3A%20%23FFFFFF%3B%0Apadding%3A%202px%3B%0Aborder%3A%201px%20solid%20%23DDDDDD%3B%0Aborder%2Dradius%3A%203px%3B%0Aborder%3A%201px%20solid%20%23CCCCCC%3B%0Amargin%3A%200%205px%3B%0A%7D%0Ah1%20%7B%0Amargin%2Dtop%3A%200%3B%0Afont%2Dsize%3A%2035px%3B%0Aline%2Dheight%3A%2040px%3B%0A%7D%0Ah2%20%7B%0Aborder%2Dbottom%3A%204px%20solid%20%23f7f7f7%3B%0Apadding%2Dtop%3A%2010px%3B%0Apadding%2Dbottom%3A%202px%3B%0Afont%2Dsize%3A%20145%25%3B%0A%7D%0Ah3%20%7B%0Aborder%2Dbottom%3A%202px%20solid%20%23f7f7f7%3B%0Apadding%2Dtop%3A%2010px%3B%0Afont%2Dsize%3A%20120%25%3B%0A%7D%0Ah4%20%7B%0Aborder%2Dbottom%3A%201px%20solid%20%23f7f7f7%3B%0Amargin%2Dleft%3A%208px%3B%0Afont%2Dsize%3A%20105%25%3B%0A%7D%0Ah5%2C%20h6%20%7B%0Aborder%2Dbottom%3A%201px%20solid%20%23ccc%3B%0Afont%2Dsize%3A%20105%25%3B%0A%7D%0Aa%20%7B%0Acolor%3A%20%230033dd%3B%0Atext%2Ddecoration%3A%20none%3B%0A%7D%0Aa%3Ahover%20%7B%0Acolor%3A%20%236666ff%3B%20%7D%0Aa%3Avisited%20%7B%0Acolor%3A%20%23800080%3B%20%7D%0Aa%3Avisited%3Ahover%20%7B%0Acolor%3A%20%23BB00BB%3B%20%7D%0Aa%5Bhref%5E%3D%22http%3A%22%5D%20%7B%0Atext%2Ddecoration%3A%20underline%3B%20%7D%0Aa%5Bhref%5E%3D%22https%3A%22%5D%20%7B%0Atext%2Ddecoration%3A%20underline%3B%20%7D%0A%0Acode%20%3E%20span%2Ekw%20%7B%20color%3A%20%23555%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%0Acode%20%3E%20span%2Edt%20%7B%20color%3A%20%23902000%3B%20%7D%20%0Acode%20%3E%20span%2Edv%20%7B%20color%3A%20%2340a070%3B%20%7D%20%0Acode%20%3E%20span%2Ebn%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Efl%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Ech%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Est%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Eco%20%7B%20color%3A%20%23888888%3B%20font%2Dstyle%3A%20italic%3B%20%7D%20%0Acode%20%3E%20span%2Eot%20%7B%20color%3A%20%23007020%3B%20%7D%20%0Acode%20%3E%20span%2Eal%20%7B%20color%3A%20%23ff0000%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%0Acode%20%3E%20span%2Efu%20%7B%20color%3A%20%23900%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%20code%20%3E%20span%2Eer%20%7B%20color%3A%20%23a61717%3B%20background%2Dcolor%3A%20%23e3d2d2%3B%20%7D%20%0A" rel="stylesheet" type="text/css" />

</head>

<body>




<h1 class="title toc-ignore">Checking Availability with rdfp</h1>
<h4 class="author"><em>Steven M. Mortimer</em></h4>
<h4 class="date"><em>2018-03-29</em></h4>


<div id="TOC">
<ul>
<li><a href="#availability-by-month">Availability by Month</a><ul>
<li><a href="#a-lineitem-from-scratch">A LineItem from Scratch</a></li>
<li><a href="#modifying-an-existing-lineitem">Modifying an Existing LineItem</a></li>
<li><a href="#creating-datetimes-in-dfp">Creating Datetimes in DFP</a></li>
<li><a href="#generating-forecasts">Generating Forecasts</a></li>
</ul></li>
<li><a href="#availability-by-targeting-criteria">Availability by Targeting Criteria</a><ul>
<li><a href="#determining-geo-ids">Determining Geo Ids</a></li>
<li><a href="#setting-up-the-targeting">Setting up The Targeting</a></li>
<li><a href="#requesting-targeting-criteria-breakdowns">Requesting Targeting Criteria Breakdowns</a></li>
<li><a href="#parsing-targeting-criteria-breakdowns">Parsing Targeting Criteria Breakdowns</a></li>
</ul></li>
<li><a href="#availability-for-an-existing-line">Availability for an Existing Line</a></li>
<li><a href="#check-out-the-tests">Check out the Tests</a></li>
</ul>
</div>

<p>First, we load <strong>rdfp</strong> and specify the DFP network we would like to connect to. Then we authenticate by using <code>dfp_auth()</code>. Any existing cached token would be used or we will be prompted to authenticate via the browser.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(rdfp)
<span class="kw">options</span>(<span class="dt">rdfp.network_code =</span> <span class="dv">123456789</span>)
<span class="kw">df_auth</span>()</code></pre></div>
<div id="availability-by-month" class="section level3">
<h3>Availability by Month</h3>
<p>Ad traffickers or display advertising reporters might get requests to determine the availability of a line item by month for a multi-month contract proposal. A LineItem has one InventoryTargeting object that describes which AdUnit and Placement objects it can target, and optional additional Targeting subclass objects that represent geographical, custom, or other criteria. You can either:</p>
<ol style="list-style-type: decimal">
<li>Create your own line item from scratch</li>
<li>Use <code>dfp_getLineItemsByStatement()</code> to pull down details on a line item and modify any fields that need to be different for your line item.</li>
</ol>
<div id="a-lineitem-from-scratch" class="section level4">
<h4>A LineItem from Scratch</h4>
<p>Creating your own line item is easy. Some line item fields are absolutely required in order to forecast so you may need to try different lines to see how they forecast. Personally, I’ve found that most line items need the fields we create in the example below (e.g <code>primaryGoal</code>, <code>targeting</code>, etc). <strong>One quirk with the DFP API is that the fields on your line item must be provided in the same order as the reference documentation.</strong> You can review the documentation for this object at <a href="https://developers.google.com/doubleclick-publishers/docs/reference/v201802/LineItemService.LineItem" class="uri">https://developers.google.com/doubleclick-publishers/docs/reference/v201802/LineItemService.LineItem</a></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">sample_line &lt;-<span class="st"> </span><span class="kw">list</span>()
sample_line<span class="op">$</span>startDateTime &lt;-<span class="st"> ''</span>
sample_line<span class="op">$</span>endDateTime &lt;-<span class="st"> ''</span>
sample_line<span class="op">$</span>deliveryRateType &lt;-<span class="st"> 'EVENLY'</span>
sample_line<span class="op">$</span>lineItemType &lt;-<span class="st"> 'STANDARD'</span>
sample_line<span class="op">$</span>priority &lt;-<span class="st"> </span><span class="dv">8</span>
sample_line<span class="op">$</span>costType &lt;-<span class="st"> 'CPM'</span>
sample_line<span class="op">$</span>creativePlaceholders<span class="op">$</span>size &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">width=</span><span class="dv">666</span>, <span class="dt">height=</span><span class="dv">176</span>, <span class="dt">isAspectRatio=</span><span class="st">'false'</span>)
sample_line<span class="op">$</span>creativePlaceholders<span class="op">$</span>expectedCreativeCount &lt;-<span class="st"> </span><span class="dv">1</span>
sample_line<span class="op">$</span>creativePlaceholders<span class="op">$</span>creativeSizeType &lt;-<span class="st"> 'PIXEL'</span>
sample_line<span class="op">$</span>primaryGoal &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">goalType=</span><span class="st">'LIFETIME'</span>, <span class="dt">unitType=</span><span class="st">'IMPRESSIONS'</span>, <span class="dt">units=</span><span class="dv">1000</span>)
sample_line<span class="op">$</span>targeting &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">inventoryTargeting=</span><span class="kw">list</span>(<span class="dt">targetedAdUnits=</span><span class="kw">list</span>(<span class="dt">adUnitId=</span><span class="dv">133765936</span>, 
                                                                           <span class="dt">includeDescendants=</span><span class="st">&quot;true&quot;</span>)))</code></pre></div>
<p>You’ll notice that this example line item does not have targeting, which you can add. It also does not have a <code>startDateTime</code> and <code>endDateTime</code>. We’ll write a loop and pass those in each time to get availability for each month across multiple months.</p>
</div>
<div id="modifying-an-existing-lineitem" class="section level4">
<h4>Modifying an Existing LineItem</h4>
<p>If you want to use an existing line item because it’s already got so many details, then here is an example of how you would pull that item down and use it. You will need to change out the <code>filterStatement</code> to pick the line item you want.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">my_filter &lt;-<span class="st"> &quot;WHERE LineItemType='STANDARD' and Status='DELIVERING' LIMIT 10&quot;</span>
line_item_details &lt;-<span class="st"> </span><span class="kw">dfp_getLineItemsByStatement</span>(<span class="kw">list</span>(<span class="dt">filterStatement=</span><span class="kw">list</span>(<span class="dt">query=</span>my_filter)))

<span class="co"># pull out the 1st line item in the list of returned results</span>
<span class="co"># we'll use this as a template for creating the hypothetical line items</span>
single_item &lt;-<span class="st"> </span>line_item_details[[<span class="dv">1</span>]]</code></pre></div>
</div>
<div id="creating-datetimes-in-dfp" class="section level4">
<h4>Creating Datetimes in DFP</h4>
<p>DFP keeps track of dates and times by separating things like the year, month, and day into 3 separate integers. The special DFP format requires a function to convert <code>Date</code> objects in R into the corresponding DFP list. The following function is helpful in doing just that.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># supply a datetime</span>
<span class="kw">dfp_date_to_list</span>(<span class="kw">Sys.time</span>())
<span class="co">#&gt; The date provided is not at least 1 hour into the future. Setting to one hour after now.</span>
<span class="co">#&gt; $date</span>
<span class="co">#&gt; $date$year</span>
<span class="co">#&gt; [1] 2018</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $date$month</span>
<span class="co">#&gt; [1] 4</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $date$day</span>
<span class="co">#&gt; [1] 6</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $hour</span>
<span class="co">#&gt; [1] 22</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $minute</span>
<span class="co">#&gt; [1] 21</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $second</span>
<span class="co">#&gt; [1] 10</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $timeZoneID</span>
<span class="co">#&gt; [1] &quot;America/New_York&quot;</span>
<span class="co"># supply a date and assume the beginning of the day for hours, mins, secs</span>
<span class="kw">dfp_date_to_list</span>(<span class="kw">Sys.Date</span>()<span class="op">+</span><span class="dv">1</span>, <span class="st">&quot;beginning&quot;</span>)
<span class="co">#&gt; The date provided is not at least 1 hour into the future. Setting to one hour after now.</span>
<span class="co">#&gt; $date</span>
<span class="co">#&gt; $date$year</span>
<span class="co">#&gt; [1] 2018</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $date$month</span>
<span class="co">#&gt; [1] 4</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $date$day</span>
<span class="co">#&gt; [1] 6</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $hour</span>
<span class="co">#&gt; [1] 22</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $minute</span>
<span class="co">#&gt; [1] 21</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $second</span>
<span class="co">#&gt; [1] 10</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $timeZoneID</span>
<span class="co">#&gt; [1] &quot;America/New_York&quot;</span></code></pre></div>
</div>
<div id="generating-forecasts" class="section level4">
<h4>Generating Forecasts</h4>
<p>Here is an example of how to loop through individual months and determine availability 6 months out for the sample line item created previously. It is fairly straightforward to take the month start and end dates and substitute them into the hypothetical line item. The one quirk is that, in order to follow the API, we must create lists of lists that are redundant at times. For example, the forecast request has a <code>lineItem</code> field that takes a <code>ProspectiveLineItem</code> that contains its own <code>lineItem</code> field: <code>list(lineItem=list(lineItem=this_sample_line) ...</code>. As long as you follow the object fields according to the Google reference documentation, then everything should work. Most everything needs to be formed as a list of lists with field names.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">all_forecasts &lt;-<span class="st"> </span><span class="ot">NULL</span>
month_start_dates &lt;-<span class="st"> </span><span class="kw">as.Date</span>(<span class="kw">format</span>(<span class="kw">Sys.Date</span>() <span class="op">%m+%</span><span class="st"> </span><span class="kw">months</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">6</span>), <span class="st">'%Y-%m-01'</span>))
month_end_dates &lt;-<span class="st"> </span><span class="kw">ceiling_date</span>(month_start_dates, <span class="st">'months'</span>) <span class="op">-</span><span class="st"> </span><span class="dv">1</span>
<span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="kw">length</span>(month_start_dates)){
  this_sample_line &lt;-<span class="st"> </span>sample_line
  this_sample_line<span class="op">$</span>startDateTime &lt;-<span class="st"> </span><span class="kw">dfp_date_to_list</span>(month_start_dates[i], <span class="dt">daytime=</span><span class="st">'beginning'</span>)
  this_sample_line<span class="op">$</span>endDateTime &lt;-<span class="st"> </span><span class="kw">dfp_date_to_list</span>(month_end_dates[i], <span class="dt">daytime=</span><span class="st">'end'</span>)
  forecast_request &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">lineItem=</span><span class="kw">list</span>(<span class="dt">lineItem=</span>this_sample_line),
                           <span class="dt">forecastOptions=</span><span class="kw">list</span>(<span class="dt">includeTargetingCriteriaBreakdown=</span><span class="st">'false'</span>, 
                                                <span class="dt">includeContendingLineItems=</span><span class="st">'false'</span>))
  this_result &lt;-<span class="st"> </span><span class="kw">dfp_getAvailabilityForecast</span>(forecast_request)
  this_result &lt;-<span class="st"> </span>this_result[,<span class="kw">c</span>(<span class="st">'unitType'</span>, <span class="st">'availableUnits'</span>, <span class="st">'reservedUnits'</span>)]
  this_result<span class="op">$</span>forecast_month &lt;-<span class="st"> </span><span class="kw">format</span>(month_start_dates[i], <span class="st">'%Y-%m'</span>)
  all_forecasts &lt;-<span class="st"> </span><span class="kw">rbind</span>(all_forecasts, this_result)
}
all_forecasts
<span class="co">#&gt; # A tibble: 6 x 4</span>
<span class="co">#&gt;   unitType    availableUnits reservedUnits forecast_month</span>
<span class="co">#&gt;   &lt;chr&gt;                &lt;dbl&gt;         &lt;dbl&gt; &lt;chr&gt;         </span>
<span class="co">#&gt; 1 IMPRESSIONS       7699620.         1000. 2018-05       </span>
<span class="co">#&gt; 2 IMPRESSIONS       7541226.         1000. 2018-06       </span>
<span class="co">#&gt; 3 IMPRESSIONS       7886497.         1000. 2018-07       </span>
<span class="co">#&gt; 4 IMPRESSIONS       7671476.         1000. 2018-08       </span>
<span class="co">#&gt; 5 IMPRESSIONS       7552982.         1000. 2018-09       </span>
<span class="co">#&gt; 6 IMPRESSIONS       7839864.         1000. 2018-10</span></code></pre></div>
</div>
</div>
<div id="availability-by-targeting-criteria" class="section level3">
<h3>Availability by Targeting Criteria</h3>
<p>The previous example shows how to determine availability across multiple months for a single line item. It is also possible to determine the availability for each targeting segment of your forecast. The <code>dfp_getAvailabilityForecast()</code> function takes a second or two, so it is very inefficient to submit each county individually. Instead, you can submit a line item with targeting that says County A or County B or County C … until you’ve covered each county that you need a forecast for. If you ask for targeting criteria breakdowns in the <code>forecastOptions</code>, then you can retrieve the availability contribution from each county while only using one call to <code>dfp_getAvailabilityForecast()</code>.</p>
<div id="determining-geo-ids" class="section level4">
<h4>Determining Geo Ids</h4>
<p>In this example, we’ll determine availability for all counties in Texas. First, you will need to determine the geography codes for all of the counties in Texas. Luckily, DFP provides a table of geographic codes for the entire world. Codes can be retrieved like so:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># get codes for US states and counties</span>
request_data &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">selectStatement=</span>
                       <span class="kw">list</span>(<span class="dt">query=</span><span class="st">&quot;SELECT </span>
<span class="st">                                      Id</span>
<span class="st">                                    , Name</span>
<span class="st">                                    , CanonicalParentId</span>
<span class="st">                                    , CountryCode</span>
<span class="st">                                    , Type </span>
<span class="st">                                  FROM Geo_Target </span>
<span class="st">                                  WHERE CountryCode='US' AND (TYPE='STATE' OR TYPE='COUNTY')&quot;</span>))

us_geos &lt;-<span class="st"> </span><span class="kw">dfp_select</span>(request_data)
texas_id &lt;-<span class="st"> </span>us_geos <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">filter</span>(type <span class="op">==</span><span class="st"> 'STATE'</span>, name <span class="op">==</span><span class="st"> 'Texas'</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">select</span>(id, <span class="dt">state=</span>name)

us_counties &lt;-<span class="st"> </span>us_geos <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">filter</span>(type <span class="op">==</span><span class="st"> 'COUNTY'</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">select</span>(id, canonicalparentid, <span class="dt">county=</span>name)

texas_counties &lt;-<span class="st"> </span><span class="kw">inner_join</span>(us_counties, texas_id, <span class="dt">by=</span><span class="kw">c</span>(<span class="st">'canonicalparentid'</span>=<span class="st">'id'</span>))</code></pre></div>
<p>Next, we need to format the geographies into objects of type <code>Location</code> that at least contain an id denoting the area.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># format the county ids into a list so they can be passed </span>
<span class="co"># over to the geoTargeting field of the ProspectiveLineItem</span>
geo_targets &lt;-<span class="st"> </span><span class="kw">as.list</span>(texas_counties<span class="op">$</span>id)
geo_targets &lt;-<span class="st"> </span><span class="kw">lapply</span>(geo_targets, <span class="dt">FUN=</span><span class="cf">function</span>(x){<span class="kw">list</span>(<span class="dt">id=</span>x)})
<span class="kw">names</span>(geo_targets) &lt;-<span class="st"> </span><span class="kw">rep</span>(<span class="st">'targetedLocations'</span>, <span class="kw">length</span>(geo_targets))</code></pre></div>
<p>The sample line we created earlier does not contain the start and end datetimes, so we’ll consider a 90-day period in the future.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">this_sample_line &lt;-<span class="st"> </span>sample_line

<span class="co"># look at availability for the next 90 days</span>
this_sample_line<span class="op">$</span>startDateTime &lt;-<span class="st"> </span><span class="kw">dfp_date_to_list</span>(<span class="kw">Sys.Date</span>() <span class="op">+</span><span class="st"> </span><span class="dv">1</span>, <span class="dt">daytime=</span><span class="st">'beginning'</span>)
<span class="co">#&gt; The date provided is not at least 1 hour into the future. Setting to one hour after now.</span>
this_sample_line<span class="op">$</span>endDateTime &lt;-<span class="st"> </span><span class="kw">dfp_date_to_list</span>(<span class="kw">Sys.Date</span>() <span class="op">+</span><span class="st"> </span><span class="dv">91</span>, <span class="dt">daytime=</span><span class="st">'end'</span>)</code></pre></div>
</div>
<div id="setting-up-the-targeting" class="section level4">
<h4>Setting up The Targeting</h4>
<p>Specifying the targeting can be a little tricky. We need to NULL the original targeting field we created in the sample line and put geoTargeting first because the documentation and the API needs elements in the order that they are specified. For example, the ForecastService needs the targeting fields to be in the order listed at <a href="https://developers.google.com/doubleclick-publishers/docs/reference/v201802/ForecastService.Targeting" class="uri">https://developers.google.com/doubleclick-publishers/docs/reference/v201802/ForecastService.Targeting</a>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># recreate the targeting field from scratch</span>
this_sample_line<span class="op">$</span>targeting &lt;-<span class="st"> </span><span class="ot">NULL</span>
this_sample_line<span class="op">$</span>targeting<span class="op">$</span>geoTargeting &lt;-<span class="st"> </span>geo_targets
<span class="co"># re-use the inventoryTargeting criteria from the original sample</span>
this_sample_line<span class="op">$</span>targeting<span class="op">$</span>inventoryTargeting &lt;-<span class="st"> </span>sample_line<span class="op">$</span>targeting<span class="op">$</span>inventoryTargeting</code></pre></div>
</div>
<div id="requesting-targeting-criteria-breakdowns" class="section level4">
<h4>Requesting Targeting Criteria Breakdowns</h4>
<p>Finally, we’ll make the request to determine availability. There are 2 important details in getting back the breakdown of availability for each county in this example.</p>
<ol style="list-style-type: decimal">
<li>Ensure that <code>includeTargetingCriteriaBreakdown='true'</code></li>
<li>Ensure that <code>as_df=FALSE</code> in <code>dfp_getAvailabilityForecast()</code></li>
</ol>
<p>Targeting criteria breakdowns are omitted by default so we need to tell DFP to return them. Those breakdowns are formatted as a nested list, so if you do not specify, you’ll be stuck with a very wide data.frame containing one column for every element in the nested list and it is not easy to work with.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># request the targeting criteria breakdown this time to get that detail</span>
forecast_request &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">lineItem=</span><span class="kw">list</span>(<span class="dt">lineItem=</span>this_sample_line),
                         <span class="dt">forecastOptions=</span><span class="kw">list</span>(<span class="dt">includeTargetingCriteriaBreakdown=</span><span class="st">'true'</span>, 
                                              <span class="dt">includeContendingLineItems=</span><span class="st">'false'</span>))

<span class="co"># get the forecasted availability and make sure to specify as_df=FALSE</span>
this_result &lt;-<span class="st"> </span><span class="kw">dfp_getAvailabilityForecast</span>(forecast_request, <span class="dt">as_df=</span><span class="ot">FALSE</span>)[[<span class="dv">1</span>]]
breakdowns &lt;-<span class="st"> </span>this_result[<span class="kw">c</span>(<span class="kw">names</span>(this_result) <span class="op">%in%</span><span class="st"> 'targetingCriteriaBreakdowns'</span>)]</code></pre></div>
</div>
<div id="parsing-targeting-criteria-breakdowns" class="section level4">
<h4>Parsing Targeting Criteria Breakdowns</h4>
<p>Once you’ve got the result, you’ll see an element in the list called <code>targetingCriteriaBreakdowns</code>. This element contains a breakdown for each targeting field specified, including the inventory targeting that is for the ad unit. We are not interested in that breakdown and it is not mutually exclusive from the geoTargeting, so we need to exclude. There are many ways to determine the break downs you want. In the example below we use <code>sapply</code> to find all breakdowns that have a dimension of <code>'GEOGRAPHY'</code>, but we could also check that the targetingCriteriaId is in the list of county ids. This all depends on which breakdowns you’re interested in and how you want to pull them out of the forecasted response.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># only select the breakdowns that are GEOGRAPHY</span>
<span class="co"># this omits the Ad Unit and Ad Size breakdowns</span>
geo_breakdowns &lt;-<span class="st"> </span>breakdowns[<span class="kw">sapply</span>(breakdowns, 
                                    <span class="dt">FUN=</span><span class="cf">function</span>(x){
                                      x<span class="op">$</span>targetingDimension <span class="op">==</span><span class="st"> 'GEOGRAPHY'</span>
                                    })]

avails &lt;-<span class="st"> </span>plyr<span class="op">::</span><span class="kw">ldply</span>(geo_breakdowns, 
                      <span class="dt">.fun=</span><span class="cf">function</span>(x){
                        <span class="kw">return</span>(<span class="kw">as.data.frame</span>(x))
                      }, <span class="dt">.id=</span><span class="ot">NULL</span>)

avails &lt;-<span class="st"> </span>avails <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">ImpressionsTotal=</span><span class="kw">as.integer</span>(matchedUnits),
         <span class="dt">ImpressionsAvailable=</span><span class="kw">as.integer</span>(availableUnits), 
         <span class="dt">ImpressionsBooked=</span><span class="kw">as.integer</span>(ImpressionsTotal<span class="op">-</span>ImpressionsAvailable), 
         <span class="dt">PctAvail=</span>ImpressionsAvailable<span class="op">/</span>ImpressionsTotal) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">select</span>(targetingCriteriaName, ImpressionsTotal, ImpressionsBooked, ImpressionsAvailable, PctAvail)</code></pre></div>
<p>The breakdowns are not necessarily mutually exclusive, so be careful when totaling them up. The counties are exclusive, so it’s okay to sum them.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># total availability across Texas counties</span>
<span class="kw">sum</span>(avails<span class="op">$</span>ImpressionsAvailable) <span class="op">/</span><span class="st"> </span><span class="kw">sum</span>(avails<span class="op">$</span>ImpressionsTotal)
<span class="co">#&gt; [1] 0.8840796</span></code></pre></div>
</div>
</div>
<div id="availability-for-an-existing-line" class="section level3">
<h3>Availability for an Existing Line</h3>
<p>Sometimes you just want to check the availability on an existing line, say, to see if you can renew an existing contract. DFP makes this very easy, by providing the function <code>dfp_getAvailabilityForecastById()</code>. You’ll need to first determine the Id of the line item you would like to check, then plug it into the function. Note the empty <code>list()</code> provided to the <code>forecastOptions</code> argument. The API will error out if you do not provide it, but an empty list will quell those error messages and utilize the default forecast options.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># request for this id with no special forecastOptions</span>
forecast_request &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">lineItemId=</span>single_item<span class="op">$</span>id,
                         <span class="dt">forecastOptions =</span> <span class="kw">list</span>())

this_result &lt;-<span class="st"> </span><span class="kw">dfp_getAvailabilityForecastById</span>(forecast_request)
this_result[,<span class="kw">c</span>(<span class="st">'lineItemId'</span>, <span class="st">'orderId'</span>, <span class="st">'availableUnits'</span>, <span class="st">'deliveredUnits'</span>, <span class="st">'matchedUnits'</span>)]
<span class="co">#&gt; # A tibble: 1 x 5</span>
<span class="co">#&gt;    lineItemId     orderId availableUnits deliveredUnits matchedUnits</span>
<span class="co">#&gt;         &lt;dbl&gt;       &lt;dbl&gt;          &lt;dbl&gt;          &lt;dbl&gt;        &lt;dbl&gt;</span>
<span class="co">#&gt; 1 4382815843. 2117726531.       1455385.        207382.     1783874.</span></code></pre></div>
</div>
<div id="check-out-the-tests" class="section level3">
<h3>Check out the Tests</h3>
<p>The <strong>rdfp</strong> package has quite a bit of unit test coverage to track any changes made between newly released versions of DFP (typically 4 each year). These tests are an excellent source of examples because they cover most all cases of utilizing the package functions.</p>
<p>For example, if you’re not sure on how to use custom date ranges when requesting a report through the ReportService, just check out the tests at <a href="https://github.com/StevenMMortimer/rdfp/blob/master/tests/testthat/test-ReportService.R" class="uri">https://github.com/StevenMMortimer/rdfp/blob/master/tests/testthat/test-ReportService.R</a></p>
<p>If you want to know how to create a user, just look at the test for <code>dfp_createUsers()</code></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">request_data &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">users=</span><span class="kw">list</span>(<span class="dt">name=</span><span class="st">&quot;TestUser - 1&quot;</span>,
                                <span class="dt">email=</span><span class="st">&quot;testuser123456789@gmail.com&quot;</span>,
                                <span class="dt">roleId=</span><span class="op">-</span><span class="dv">1</span>)
                     )
dfp_createUsers_result &lt;-<span class="st"> </span><span class="kw">dfp_createUsers</span>(request_data)</code></pre></div>
</div>



<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
